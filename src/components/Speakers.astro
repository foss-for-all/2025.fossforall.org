---
const { lang } = Astro.props;
import { renderMarkdown } from "@/lib/utils";
import { WebsiteConfig } from "@/config";
import { createHash } from 'crypto';
import type { Speaker } from "@/models/Speaker";
import { SpeakerCardAndModal } from "@/components/SpeakerCardAndModal";
import { SpeakerOrganizations } from "@/data/speakerOrganizations";

const config = WebsiteConfig(lang);

const response = await fetch(
    `${config.pretalx.baseUrl}/api/events/${config.pretalx.eventSlug}/speakers/`,
    {
        headers: new Headers({
            Authorization: "Token " + import.meta.env.PRETALX_TOKEN,
        }),
    },
);
let speakers: Speaker[] = (await response.json())["results"];
const {
  speakersToExpose = [],
} = Astro.props;

// Merge local organization data with API speaker data
speakers = speakers.map((speaker) => {
    const orgData = SpeakerOrganizations.find(
        (org) => org.name === speaker.name
    );
    return {
        ...speaker,
        organization: orgData?.organization || speaker.organization,
    };
});

// Process markdown in biography at build time
speakers = await Promise.all(speakers.map(async (speaker) => ({
    ...speaker,
    biography: await renderMarkdown(speaker.biography),
})));
---

<div class="columns is-multiline">
    {
        speakers.map((speaker: Speaker) => speakersToExpose.includes(speaker.code) ? (
        <SpeakerCardAndModal client:load speaker={speaker} gravatarHash={createHash("SHA256").update(speaker.email, "utf-8").digest("hex")} />
        ):(<></>))
    }
</div>
